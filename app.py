import streamlit as st
import requests
import json
import base64
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import numpy as np
from datetime import datetime, timedelta
import psycopg2
from psycopg2.extras import RealDictCursor
import io
import warnings
warnings.filterwarnings('ignore')

# ================================
# CONFIGURA√á√ÉO DA P√ÅGINA
# ================================
st.set_page_config(
    page_title="üå± AgroAssistente IA - Sistema Inteligente",
    page_icon="üå±",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ================================
# CSS AVAN√áADO
# ================================
st.markdown("""
<style>
    .main-header {
        font-size: 3rem;
        background: linear-gradient(135deg, #2e7d32, #4caf50);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-align: center;
        margin-bottom: 1rem;
        font-weight: 800;
    }
    .response-card {
        background: linear-gradient(135deg, #f8fffd, #e8f5e9);
        border-left: 6px solid #2e7d32;
        padding: 2rem;
        margin: 1.5rem 0;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .analysis-card {
        background: linear-gradient(135deg, #fff3e0, #ffecb3);
        border-left: 6px solid #ff9800;
        padding: 1.5rem;
        margin: 1rem 0;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .metric-card {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        padding: 20px;
        border-radius: 12px;
        color: white;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .user-message {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        padding: 1rem;
        border-radius: 15px;
        margin: 0.5rem 0;
        border: 1px solid #90caf9;
    }
    .assistant-message {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        padding: 1rem;
        border-radius: 15px;
        margin: 0.5rem 0;
        border: 1px solid #a5d6a7;
    }
</style>
""", unsafe_allow_html=True)

# ================================
# CONFIGURA√á√ïES
# ================================
DB_CONFIG = {
    "host": "dpg-d361csili9vc738rea90-a.oregon-postgres.render.com",
    "database": "postgresql_agro",
    "user": "postgresql_agro_user",
    "password": "gl5pErtk8tC2vqFLfswn7B7ocoxK7gk5",
    "port": "5432"
}

# ================================
# SISTEMA UNIFICADO DE IA
# ================================
class AgroIntelligentAssistant:
    def __init__(self):
        self.db = AgroDatabase()
        self.embrapa_api = EmbrapaAPI()
        self.conversation_history = []
    
    def get_business_context(self):
        """Obt√©m todos os dados do neg√≥cio para contexto"""
        productions = self.db.load_productions()
        inputs = self.db.load_inputs()
        price_config = self.db.load_price_config()
        
        context = {
            "has_data": not productions.empty,
            "productions": [],
            "financial_summary": {},
            "insights": []
        }
        
        if not productions.empty:
            # Resumo das produ√ß√µes
            context["productions"] = productions.to_dict('records')
            
            # An√°lise financeira
            total_first_quality = productions['first_quality'].sum()
            total_second_quality = productions['second_quality'].sum()
            total_production = total_first_quality + total_second_quality
            
            # C√°lculo de receitas
            revenue = 0
            for _, row in productions.iterrows():
                product = row['product']
                price_row = price_config[price_config['product'] == product]
                first_price = price_row['first_quality_price'].values[0] if not price_row.empty else 10.0
                second_price = price_row['second_quality_price'].values[0] if not price_row.empty else 5.0
                revenue += row['first_quality'] * first_price + row['second_quality'] * second_price
            
            total_costs = inputs['cost'].sum() if not inputs.empty else 0
            profit = revenue - total_costs
            profit_margin = (profit / revenue * 100) if revenue > 0 else 0
            
            context["financial_summary"] = {
                "total_revenue": revenue,
                "total_costs": total_costs,
                "profit": profit,
                "profit_margin": profit_margin,
                "total_production": total_production,
                "first_quality_percent": (total_first_quality / total_production * 100) if total_production > 0 else 0
            }
            
            # Insights
            if profit_margin < 20:
                context["insights"].append("Margem de lucro pode ser melhorada")
            if context["financial_summary"]["first_quality_percent"] < 60:
                context["insights"].append("Percentual de 1¬™ qualidade abaixo do ideal")
            
            # Cultura principal
            main_crop = productions.groupby('product')['first_quality'].sum().idxmax()
            context["main_crop"] = main_crop
            
        return context
    
    def search_embrapa_knowledge(self, query):
        """Busca conhecimento cient√≠fico na Embrapa"""
        try:
            results = self.embrapa_api.search_all_books(query, size=3)
            if "error" in results or not results.get('hits', {}).get('hits'):
                return "N√£o encontrei informa√ß√µes espec√≠ficas na base cient√≠fica da Embrapa para esta pergunta."
            
            # Processar resultados
            knowledge = []
            for hit in results['hits']['hits'][:3]:
                source = hit['_source']
                knowledge.append({
                    'pergunta': source.get('question', ''),
                    'resposta': source.get('answer', '')[:300] + "...",
                    'livro': source.get('book', ''),
                    'relevancia': hit.get('_score', 0)
                })
            
            return knowledge
        except Exception as e:
            return f"Erro ao acessar base cient√≠fica: {str(e)}"
    
    def generate_intelligent_response(self, user_message):
        """Gera resposta inteligente integrando todos os dados"""
        
        # Obter contexto do neg√≥cio
        business_context = self.get_business_context()
        
        # Buscar conhecimento cient√≠fico
        scientific_knowledge = self.search_embrapa_knowledge(user_message)
        
        # Construir prompt contextual
        prompt = self._build_contextual_prompt(user_message, business_context, scientific_knowledge)
        
        # Gerar resposta (aqui usaremos uma l√≥gica inteligente de templates)
        response = self._generate_contextual_response(prompt, business_context, scientific_knowledge)
        
        # Atualizar hist√≥rico
        self.conversation_history.append({
            "user": user_message,
            "assistant": response,
            "timestamp": datetime.now()
        })
        
        return response
    
    def _build_contextual_prompt(self, user_message, business_context, scientific_knowledge):
        """Constr√≥i o prompt contextual para a resposta"""
        
        prompt_parts = []
        
        # Contexto do neg√≥cio
        if business_context["has_data"]:
            financial = business_context["financial_summary"]
            prompt_parts.append(f"""
            CONTEXTO DO NEG√ìCIO:
            - Cultura principal: {business_context.get('main_crop', 'N√£o identificada')}
            - Produ√ß√£o total: {financial['total_production']:.0f} caixas
            - Receita: R$ {financial['total_revenue']:.2f}
            - Custos: R$ {financial['total_costs']:.2f}
            - Lucro: R$ {financial['profit']:.2f}
            - Margem: {financial['profit_margin']:.1f}%
            - Qualidade 1¬™: {financial['first_quality_percent']:.1f}%
            - Insights: {', '.join(business_context['insights']) if business_context['insights'] else 'Nenhum insight cr√≠tico'}
            """)
        else:
            prompt_parts.append("CONTEXTO DO NEG√ìCIO: Nenhum dado de produ√ß√£o cadastrado ainda.")
        
        # Conhecimento cient√≠fico
        if isinstance(scientific_knowledge, list) and scientific_knowledge:
            sci_text = "CONHECIMENTO CIENT√çFICO EMBRAPA:\n"
            for i, knowledge in enumerate(scientific_knowledge, 1):
                sci_text += f"""
                {i}. {knowledge['pergunta']}
                   Resposta: {knowledge['resposta']}
                   Fonte: {knowledge['livro']} (Relev√¢ncia: {knowledge['relevancia']:.1f})
                """
            prompt_parts.append(sci_text)
        else:
            prompt_parts.append("CONHECIMENTO CIENT√çFICO: " + str(scientific_knowledge))
        
        prompt_parts.append(f"PERGUNTA DO USU√ÅRIO: {user_message}")
        
        return "\n".join(prompt_parts)
    
    def _generate_contextual_response(self, prompt, business_context, scientific_knowledge):
        """Gera resposta contextual integrando todas as informa√ß√µes"""
        
        # An√°lise da pergunta do usu√°rio
        user_question = prompt.split("PERGUNTA DO USU√ÅRIO: ")[-1].lower()
        
        # Resposta baseada no tipo de pergunta
        if any(word in user_question for word in ['como', 'fazer', 'procedimento']):
            return self._generate_how_to_response(user_question, business_context, scientific_knowledge)
        elif any(word in user_question for word in ['quanto', 'custo', 'pre√ßo', 'financeiro']):
            return self._generate_financial_response(user_question, business_context, scientific_knowledge)
        elif any(word in user_question for word in ['qualidade', 'produtividade', 'rendimento']):
            return self._generate_quality_response(user_question, business_context, scientific_knowledge)
        elif any(word in user_question for word in ['problema', 'doen√ßa', 'praga']):
            return self._generate_problem_response(user_question, business_context, scientific_knowledge)
        else:
            return self._generate_general_response(user_question, business_context, scientific_knowledge)
    
    def _generate_how_to_response(self, question, business_context, scientific_knowledge):
        """Gera resposta para perguntas de procedimento"""
        
        response_parts = ["üå± **Orienta√ß√£o T√©cnica Personalizada**\n\n"]
        
        # Adicionar conhecimento cient√≠fico
        if isinstance(scientific_knowledge, list) and scientific_knowledge:
            response_parts.append("**Base Cient√≠fica Embrapa:**")
            for knowledge in scientific_knowledge:
                response_parts.append(f"üìö {knowledge['resposta']}")
            response_parts.append("")
        
        # Adicionar contexto do neg√≥cio
        if business_context["has_data"]:
            financial = business_context["financial_summary"]
            response_parts.append("**Contexto do Seu Neg√≥cio:**")
            response_parts.append(f"‚Ä¢ Sua produ√ß√£o atual: {financial['total_production']:.0f} caixas")
            response_parts.append(f"‚Ä¢ Margem atual: {financial['profit_margin']:.1f}%")
            
            if financial['first_quality_percent'] < 60:
                response_parts.append("‚Ä¢ üí° **Oportunidade**: Voc√™ pode aumentar a qualidade 1¬™ para melhorar seus rendimentos")
            
            if financial['profit_margin'] < 15:
                response_parts.append("‚Ä¢ üí∞ **Alerta**: Sua margem est√° baixa - considere otimizar custos")
        
        response_parts.append("\n**Pr√≥ximos Passos Recomendados:**")
        response_parts.append("1. Implemente as pr√°ticas recomendadas pela Embrapa")
        response_parts.append("2. Monitore os resultados semanalmente")
        response_parts.append("3. Ajuste conforme as condi√ß√µes locais")
        
        return "\n".join(response_parts)
    
    def _generate_financial_response(self, question, business_context, scientific_knowledge):
        """Gera resposta para perguntas financeiras"""
        
        response_parts = ["üí∞ **An√°lise Financeira**\n\n"]
        
        if business_context["has_data"]:
            financial = business_context["financial_summary"]
            
            response_parts.append("**Seu Desempenho Atual:**")
            response_parts.append(f"‚Ä¢ üìà **Receita Total**: R$ {financial['total_revenue']:,.2f}")
            response_parts.append(f"‚Ä¢ üí∏ **Custos Totais**: R$ {financial['total_costs']:,.2f}")
            response_parts.append(f"‚Ä¢ üéØ **Lucro L√≠quido**: R$ {financial['profit']:,.2f}")
            response_parts.append(f"‚Ä¢ üìä **Margem de Lucro**: {financial['profit_margin']:.1f}%")
            response_parts.append(f"‚Ä¢ üåü **Qualidade 1¬™**: {financial['first_quality_percent']:.1f}% da produ√ß√£o")
            
            # Recomenda√ß√µes baseadas nos dados
            response_parts.append("\n**üí° Recomenda√ß√µes Financeiras:**")
            
            if financial['profit_margin'] < 10:
                response_parts.append("‚Ä¢ **A√ß√£o Urgente**: Sua margem est√° cr√≠tica. Reveja custos e pre√ßos")
            elif financial['profit_margin'] < 20:
                response_parts.append("‚Ä¢ **Otimiza√ß√£o**: H√° espa√ßo para melhorar a margem. Foque em efici√™ncia")
            else:
                response_parts.append("‚Ä¢ **Excelente**: Margem saud√°vel! Mantenha o bom trabalho")
            
            if financial['first_quality_percent'] < 50:
                response_parts.append("‚Ä¢ **Qualidade**: Invista em pr√°ticas que aumentem a 1¬™ qualidade - tem alto retorno")
                
        else:
            response_parts.append("üìä **Para an√°lises financeiras precisas, cadastre seus dados de produ√ß√£o e custos.**")
        
        # Adicionar conhecimento cient√≠fico se relevante
        if isinstance(scientific_knowledge, list) and scientific_knowledge:
            response_parts.append("\n**Conhecimento Cient√≠fico Aplic√°vel:**")
            for knowledge in scientific_knowledge[:2]:
                response_parts.append(f"‚Ä¢ {knowledge['resposta']}")
        
        return "\n".join(response_parts)
    
    def _generate_quality_response(self, question, business_context, scientific_knowledge):
        """Gera resposta para perguntas sobre qualidade"""
        
        response_parts = ["üéØ **Gest√£o de Qualidade**\n\n"]
        
        if business_context["has_data"]:
            financial = business_context["financial_summary"]
            
            response_parts.append(f"**Seu Desempenho de Qualidade:**")
            response_parts.append(f"‚Ä¢ {financial['first_quality_percent']:.1f}% da sua produ√ß√£o √© 1¬™ qualidade")
            
            if financial['first_quality_percent'] >= 70:
                response_parts.append("‚Ä¢ ‚úÖ **Excelente**! Sua qualidade est√° acima da m√©dia")
            elif financial['first_quality_percent'] >= 50:
                response_parts.append("‚Ä¢ ‚ö†Ô∏è **Bom**, mas pode melhorar. H√° espa√ßo para crescimento")
            else:
                response_parts.append("‚Ä¢ üîÑ **Precisa melhorar**. Foque em pr√°ticas que elevem a qualidade")
        
        # Conhecimento cient√≠fico sobre qualidade
        if isinstance(scientific_knowledge, list) and scientific_knowledge:
            response_parts.append("\n**T√©cnicas Comprovadas para Qualidade:**")
            for knowledge in scientific_knowledge:
                response_parts.append(f"‚Ä¢ {knowledge['resposta']}")
        else:
            response_parts.append("\n**Dicas Gerais para Melhorar Qualidade:**")
            response_parts.append("‚Ä¢ Colha no ponto certo")
            response_parts.append("‚Ä¢ Maneje adequadamente o solo")
            response_parts.append("‚Ä¢ Controle pragas e doen√ßas preventivamente")
            response_parts.append("‚Ä¢ Invista em boas sementes/mudas")
        
        return "\n".join(response_parts)
    
    def _generate_problem_response(self, question, business_context, scientific_knowledge):
        """Gera resposta para problemas e doen√ßas"""
        
        response_parts = ["üîç **An√°lise de Problemas**\n\n"]
        
        response_parts.append("**Com base no conhecimento cient√≠fico da Embrapa:**")
        
        if isinstance(scientific_knowledge, list) and scientific_knowledge:
            for knowledge in scientific_knowledge:
                response_parts.append(f"‚Ä¢ {knowledge['resposta']}")
        else:
            response_parts.append("‚Ä¢ Consulte um t√©cnico agr√≠cola para diagn√≥stico preciso")
            response_parts.append("‚Ä¢ Coletar amostras para an√°lise")
            response_parts.append("‚Ä¢ Documentar sintomas e condi√ß√µes clim√°ticas")
        
        response_parts.append("\n**A√ß√µes Recomendadas:**")
        response_parts.append("1. Identifique corretamente o problema")
        response_parts.append("2. Siga as recomenda√ß√µes t√©cnicas validadas")
        response_parts.append("3. Monitore a evolu√ß√£o")
        response_parts.append("4. Registre os resultados para aprendizado futuro")
        
        if business_context["has_data"]:
            response_parts.append(f"\nüí° **Contexto da sua lavoura**: Voc√™ cultiva {business_context.get('main_crop', 'diversas culturas')}")
        
        return "\n".join(response_parts)
    
    def _generate_general_response(self, question, business_context, scientific_knowledge):
        """Gera resposta para perguntas gerais"""
        
        response_parts = ["üåæ **Assist√™ncia Agr√≠cola Integral**\n\n"]
        
        # Conhecimento cient√≠fico
        if isinstance(scientific_knowledge, list) and scientific_knowledge:
            response_parts.append("**Conhecimento Cient√≠fico da Embrapa:**")
            for knowledge in scientific_knowledge:
                response_parts.append(f"‚Ä¢ {knowledge['resposta']}")
        else:
            response_parts.append("‚Ä¢ Estou aqui para ajudar com quest√µes agr√≠colas baseadas em ci√™ncia")
        
        # Contexto do neg√≥cio
        if business_context["has_data"]:
            financial = business_context["financial_summary"]
            response_parts.append(f"\n**Resumo do Seu Neg√≥cio:**")
            response_parts.append(f"‚Ä¢ Produ√ß√£o: {financial['total_production']:.0f} caixas")
            response_parts.append(f"‚Ä¢ Lucro: R$ {financial['profit']:,.2f}")
            response_parts.append(f"‚Ä¢ Margem: {financial['profit_margin']:.1f}%")
            
            if business_context["insights"]:
                response_parts.append(f"\n**Insights Importantes:**")
                for insight in business_context["insights"]:
                    response_parts.append(f"‚Ä¢ {insight}")
        
        response_parts.append("\n**Como posso ajudar mais?** Pode me perguntar sobre:")
        response_parts.append("‚Ä¢ T√©cnicas de plantio e manejo")
        response_parts.append("‚Ä¢ An√°lise financeira da sua produ√ß√£o")
        response_parts.append("‚Ä¢ Solu√ß√£o de problemas na lavoura")
        response_parts.append("‚Ä¢ Melhoria de qualidade e produtividade")
        
        return "\n".join(response_parts)

# ================================
# CLASSES DE SUPORTE (MANTIDAS)
# ================================
class EmbrapaAuth:
    def __init__(self):
        self.consumer_key = "DI_JQ6o06C8ktdGR0pwpuSL6f3ka"
        self.consumer_secret = "BXmyFKVuIHlCsaUUS40Ya0bV8msa"
        self.token_url = "https://api.cnptia.embrapa.br/token"
        self.base64_credentials = self._get_base64_credentials()
        
    def _get_base64_credentials(self):
        credentials = f"{self.consumer_key}:{self.consumer_secret}"
        return base64.b64encode(credentials.encode()).decode()
    
    def get_access_token(self):
        headers = {
            "Authorization": f"Basic {self.base64_credentials}",
            "Content-Type": "application/x-www-form-urlencoded"
        }
        data = {"grant_type": "client_credentials"}
        
        try:
            response = requests.post(self.token_url, headers=headers, data=data, timeout=30)
            if response.status_code == 200:
                token_data = response.json()
                return {
                    "access_token": token_data.get("access_token"),
                    "expires_in": token_data.get("expires_in"),
                    "token_type": token_data.get("token_type"),
                    "timestamp": datetime.now()
                }
            else:
                return None
        except Exception:
            return None

class EmbrapaAPI:
    def __init__(self):
        self.base_url = "https://api.cnptia.embrapa.br/respondeagro/v1"
        self.auth = EmbrapaAuth()
        self.access_token = None
        self.token_expiry = None
        
    def ensure_valid_token(self):
        if self.access_token and self.token_expiry:
            if datetime.now() < self.token_expiry - timedelta(seconds=300):
                return True
        token_data = self.auth.get_access_token()
        if token_data:
            self.access_token = token_data["access_token"]
            expires_seconds = token_data["expires_in"]
            self.token_expiry = datetime.now() + timedelta(seconds=expires_seconds)
            return True
        return False
    
    def search_all_books(self, query, size=5):
        if not self.ensure_valid_token():
            return {"error": "Falha na autentica√ß√£o"}
            
        headers = {
            "Authorization": f"Bearer {self.access_token}",
            "Content-Type": "application/json"
        }
        
        payload = {
            "id": "query_all",
            "params": {
                "query_string": query,
                "from": 0,
                "size": size
            }
        }
        
        try:
            url = f"{self.base_url}/_search/template"
            response = requests.post(url, headers=headers, json=payload, timeout=30)
            return response.json() if response.status_code == 200 else {"error": f"Erro {response.status_code}"}
        except Exception as e:
            return {"error": f"Erro de conex√£o: {str(e)}"}

class AgroDatabase:
    def __init__(self):
        self.config = DB_CONFIG
    
    def get_connection(self):
        try:
            return psycopg2.connect(**self.config)
        except Exception as e:
            st.error(f"‚ùå Erro ao conectar com o banco: {str(e)}")
            return None
    
    def load_productions(self):
        conn = self.get_connection()
        if conn is None:
            return pd.DataFrame()
        try:
            query = "SELECT * FROM productions ORDER BY date DESC"
            df = pd.read_sql_query(query, conn)
            return df
        except Exception:
            return pd.DataFrame()
        finally:
            conn.close()
    
    def load_inputs(self):
        conn = self.get_connection()
        if conn is None:
            return pd.DataFrame()
        try:
            query = "SELECT * FROM inputs ORDER BY date DESC"
            df = pd.read_sql_query(query, conn)
            return df
        except Exception:
            return pd.DataFrame()
        finally:
            conn.close()
    
    def load_price_config(self):
        conn = self.get_connection()
        if conn is None:
            return pd.DataFrame()
        try:
            query = "SELECT * FROM price_config"
            df = pd.read_sql_query(query, conn)
            return df
        except Exception:
            return pd.DataFrame()
        finally:
            conn.close()

# ================================
# INTERFACE PRINCIPAL
# ================================
def main():
    # Inicializar assistente
    if "assistant" not in st.session_state:
        st.session_state.assistant = AgroIntelligentAssistant()
    
    assistant = st.session_state.assistant
    
    # Header
    st.markdown('<h1 class="main-header">üß† AgroAssistente IA</h1>', unsafe_allow_html=True)
    st.markdown('<div style="text-align: center; color: #666; margin-bottom: 2rem;">Sistema Inteligente Integrado - Embrapa + Seus Dados</div>', unsafe_allow_html=True)
    
    # Layout principal
    col1, col2 = st.columns([2, 1])
    
    with col1:
        # √Årea de conversa√ß√£o
        st.markdown("### üí¨ Conversa com o Especialista Agr√≠cola")
        
        # Exibir hist√≥rico de conversa
        for message in assistant.conversation_history[-10:]:  # √öltimas 10 mensagens
            st.markdown(f'<div class="user-message"><strong>Voc√™:</strong> {message["user"]}</div>', unsafe_allow_html=True)
            st.markdown(f'<div class="assistant-message"><strong>Assistente:</strong> {message["assistant"]}</div>', unsafe_allow_html=True)
        
        # Input do usu√°rio
        user_input = st.text_area(
            "**Fa√ßa sua pergunta sobre agricultura:**",
            placeholder="Ex: Como melhorar minha produtividade? Qual adubo usar? Analise meus custos...",
            height=100
        )
        
        col_btn1, col_btn2 = st.columns(2)
        with col_btn1:
            if st.button("üöÄ Enviar Pergunta", use_container_width=True):
                if user_input.strip():
                    with st.spinner("ü§î Analisando sua pergunta com IA..."):
                        response = assistant.generate_intelligent_response(user_input)
                        st.rerun()
                else:
                    st.warning("Por favor, digite uma pergunta")
        
        with col_btn2:
            if st.button("üîÑ Nova Conversa", use_container_width=True):
                assistant.conversation_history = []
                st.rerun()
    
    with col2:
        # Sidebar com informa√ß√µes contextuais
        st.markdown("### üìä Contexto do Seu Neg√≥cio")
        
        business_context = assistant.get_business_context()
        
        if business_context["has_data"]:
            financial = business_context["financial_summary"]
            
            st.markdown('<div class="metric-card">', unsafe_allow_html=True)
            st.metric("üì¶ Produ√ß√£o Total", f"{financial['total_production']:.0f} cx")
            st.markdown('</div>', unsafe_allow_html=True)
            
            st.markdown('<div class="metric-card">', unsafe_allow_html=True)
            st.metric("üí∞ Receita Total", f"R$ {financial['total_revenue']:,.0f}")
            st.markdown('</div>', unsafe_allow_html=True)
            
            st.markdown('<div class="metric-card">', unsafe_allow_html=True)
            st.metric("üéØ Lucro L√≠quido", f"R$ {financial['profit']:,.0f}")
            st.markdown('</div>', unsafe_allow_html=True)
            
            st.markdown('<div class="metric-card">', unsafe_allow_html=True)
            st.metric("üìà Margem", f"{financial['profit_margin']:.1f}%")
            st.markdown('</div>', unsafe_allow_html=True)
            
            # Insights r√°pidos
            st.markdown("### üí° Insights R√°pidos")
            for insight in business_context["insights"][:3]:
                st.info(insight)
                
            # Cultura principal
            st.markdown(f"**üå± Cultura Principal:** {business_context.get('main_crop', 'N√£o identificada')}")
            
        else:
            st.info("üíº **Cadastre seus dados de produ√ß√£o** para an√°lises personalizadas")
            st.markdown("""
            Com seus dados, posso ajudar com:
            ‚Ä¢ An√°lises financeiras precisas
            ‚Ä¢ Recomenda√ß√µes espec√≠ficas
            ‚Ä¢ Acompanhamento de produtividade
            ‚Ä¢ Otimiza√ß√£o de custos
            """)
        
        # Status do sistema
        st.markdown("---")
        st.markdown("### üîß Status do Sistema")
        
        # Testar conex√£o Embrapa
        if assistant.embrapa_api.ensure_valid_token():
            st.success("‚úÖ API Embrapa: Conectada")
        else:
            st.error("‚ùå API Embrapa: Desconectada")
        
        # Testar conex√£o Banco
        conn = assistant.db.get_connection()
        if conn:
            st.success("‚úÖ Banco de Dados: Conectado")
            conn.close()
        else:
            st.error("‚ùå Banco de Dados: Desconectado")
    
    # Footer
    st.markdown("---")
    st.markdown("""
    <div style='text-align: center; color: #666;'>
    <p>üöÄ <strong>AGROASSISTENTE IA</strong> - Conhecimento Cient√≠fico Embrapa + An√°lise de Dados em Tempo Real</p>
    <p>üí° Dica: Pergunte sobre t√©cnicas, finan√ßas, problemas ou an√°lises do seu neg√≥cio</p>
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()
